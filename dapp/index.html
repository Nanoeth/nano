<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
var communityContract
var walletContract
var community
var wallet
var gasLimit
window.onload = function () {
    google.charts.load('current', {'packages':['corechart']});
    function setGasLimit() {
        setTimeout(function () {
             self.web3.eth.getBlock('latest', function (err, block) {
                gasLimit = Math.floor(block.gasLimit - block.gasLimit / 1024)
                setGasLimit()
                console.log(gasLimit)
            })
        }, 5000)    
    }
    setGasLimit()
   
    var communityAddress = gup('community')
    var walletAddress = gup('wallet')
    var contracts = initContract()
    communityContract = contracts.communityContract
    walletContract = contracts.walletContract
    if (communityAddress) {
        document.getElementById('communityInfo').innerHTML = 'at ' + communityAddress
        community = communityContract.at(communityAddress)    
    } else {
        document.getElementById('walletCreation').style.display = 'none'
        document.getElementById('communityInfo').innerHTML = 'No community specified'
    }
    if (walletAddress) {
        document.getElementById('walletaction').style.display = 'block'
        wallet = walletContract.at(walletAddress)    
    }
}

</script>

<div>Community:</div>
<div id='communityInfo'></div>
<div id='walletCreation'>
    <input id='walletname'></intput><button id="createwalletbtn" onclick="createWallet()">Create wallet</button>
</div>
<div id='creationResult'></div>
<div id='walletsNS'></div>
<br />
<br />
<div id='walletaction' style='display:none'>
    <div>Wallet</div>
    <div id='walletvalue'></div>
    <div id='walletblockorigin'></div>
    <div id='walletcurrentblock'></div>
    <button onclick="requestRefill()">Request refill</button>
    <div id='requestRefillResult'></div>
    <input id='from'></intput><input id='to'></intput><input id='value'></intput><button onclick="send()">Send</button>
    <div id='sendResult'></div>
</div>



<script type="text/javascript">    
    function createWallet() {
        var name = document.getElementById('walletname')
        community.createWallet(name.value, {from: web3.eth.accounts[0], gas: gasLimit}, function (error, transactionHash) {
            var resultDiv = document.getElementById('creationResult')
            if (error) {
                resultDiv.innerHTML = error
            } else {
                resultDiv.innerHTML = 'waiting confirmation from ' + transactionHash
                tryTillResponse(transactionHash, function (error, result) {
                    console.log('createWallet')
                    console.log(result)
                    resultDiv.innerHTML = 'wallet created '
                    community.walletByName(name.value, function (error, result) {
                        document.getElementById('walletaction').style.display = 'block'
                        resultDiv.innerHTML = 'wallet created at ' + result
                        wallet = walletContract.at(result)
                        document.getElementById('createwalletbtn').disable = true
                    })
                })
            }
        })
    }
    
    function requestRefill() {
        var resultDiv = document.getElementById('requestRefillResult')
        resultDiv.innerHTML = 'Requesting refill ...'
        community.requestRefill({from: web3.eth.accounts[0], gas: gasLimit}, function (error, transactionHash) {            
            resultDiv.innerHTML = 'waiting confirmation from ' + transactionHash
            tryTillResponse(transactionHash, function (error, result) {
                console.log('requestRefill')
                console.log(result)
                resultDiv.innerHTML = 'request refill done'
            })
        })
    }
    
    function send() {
        var resultDiv = document.getElementById('sendResult')
        resultDiv.innerHTML = 'Sending ...'
        community.send(document.getElementById('from').value, document.getElementById('to').value, parseInt(document.getElementById('value').value), {from: web3.eth.accounts[0], gas: gasLimit}, function (error, transactionHash) {
            resultDiv.innerHTML = 'waiting confirmation from ' + transactionHash
            tryTillResponse(transactionHash, function (error, result) {
                console.log('sent')
                console.log(result)
                resultDiv.innerHTML = 'send done'
            })
        })
    }
    
</script>
    
    
<script type="text/javascript">
function initContract() {
 
 var communityContract = web3.eth.contract([{"constant":false,"inputs":[{"name":"_name","type":"bytes32"}],"name":"createWallet","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"_address","type":"address"}],"name":"walletByAddress","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"walletNames","outputs":[{"name":"","type":"bytes32"}],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"_name","type":"bytes32"}],"name":"walletByName","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"","type":"bytes32"}],"name":"walletsNS","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_from","type":"bytes32"},{"name":"_to","type":"bytes32"},{"name":"_value","type":"int256"}],"name":"send","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[],"name":"requestRefill","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"wallets","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"constant":false,"inputs":[],"name":"getConfig","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"inputs":[],"payable":false,"type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_arg","type":"string"}],"name":"transactionResult","type":"event"}]);

 
 var walletContract = web3.eth.contract([{"constant":true,"inputs":[],"name":"getValue","outputs":[{"name":"","type":"int256"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_value","type":"int256"}],"name":"setValue","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_blockNumber","type":"int256"}],"name":"setOriginBlock","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"getLastRefillBlockNumber","outputs":[{"name":"","type":"int256"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"getOriginBlockNumber","outputs":[{"name":"","type":"int256"}],"payable":false,"type":"function"},{"inputs":[{"name":"_owner","type":"address"},{"name":"_community","type":"address"}],"payable":false,"type":"constructor"}]);
 
return {
    communityContract: communityContract,
    walletContract: walletContract
}
}

function gup( name, url ) {
    if (!url) url = location.href;
    name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
    var regexS = "[\\?&]"+name+"=([^&#]*)";
    var regex = new RegExp( regexS );
    var results = regex.exec( url );
    return results == null ? null : results[1];
}

function tryTillResponse (txhash, done) {
  web3.eth.getTransactionReceipt(txhash, function (err, result) {
    if (!err && !result) {
      // Try again with a bit of delay
      setTimeout(function () { tryTillResponse(txhash, done) }, 500)
    } else {
      done(err,result)
    }
  })
}

function updateCommunity () {
    if (community) {
        /*
        community.wallets(function (error, result) {            
            document.getElementById('wallets').innerHTML = error ? error : 'wallets: ' + JSON.stringify(result)
        })
        community.walletsNS(function (error, result) {
            document.getElementById('walletsNS').innerHTML = error ? error : ' walletsNS: ' + JSON.stringify(result)
        })*/
        /*community.walletNames(function (error, result) {
            document.getElementById('walletsNS').innerHTML = error ? error : ' walletsNS: ' + decodeURIComponent(result.replace('0x', '').replace(/(..)/g, '%$1'))
        })*/
    }
    setTimeout(function () {
        updateCommunity ()
    }, 1000)
}
updateCommunity()

var chartPlot = [['Block', 'Balance']]
function plotChart (value) {
    web3.eth.getBlockNumber(function (error, blockNumberResult) {
        chartPlot.push([blockNumberResult, parseInt(value)])
        var data = google.visualization.arrayToDataTable(chartPlot)
         var options = {
          title: 'Balance/Block',
          curveType: 'function',
          legend: { position: 'bottom' }
        };
        var chart = new google.visualization.LineChart(document.getElementById('curve_chart'));
        chart.draw(data, options);
    })
}
function updateWallet () {
    if (wallet) {
        wallet.getValue(function (error, result) {
            document.getElementById('walletvalue').innerHTML = error ? error : 'value:' + result.toString(10)
            plotChart(result.toString(10))
        })
        wallet.getOriginBlockNumber(function (error, result) {
            document.getElementById('walletblockorigin').innerHTML = error ? error : 'block origin:' + result.toString(10)
            web3.eth.getBlockNumber(function (error, blockNumberResult) {
                document.getElementById('walletcurrentblock').innerHTML = error ? error : 'current block: ' + blockNumberResult.toString() + '. block elapsed: ' + (blockNumberResult - result.toString(10)).toString()
            })
        })
       
    }
    setTimeout(function () {
        updateWallet ()
    }, 1000)
}
updateWallet()

</script>

<div id="curve_chart" style="width: 900px; height: 500px"></div>